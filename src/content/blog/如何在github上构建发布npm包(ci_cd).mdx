---
title: "å¦‚ä½•åœ¨githubä¸Šæ„å»ºå‘å¸ƒnpmåŒ…(ci_cd)"
summary: "github action è‡ªåŠ¨åŒ–"
date: "2022-05-16 11:56:18"
draft: false
tags:
- npm
- github action
---


# why
ä¸ºä½•ä¼šç”Ÿå‡ºè¿™ä¸ªæƒ³æ³•ï¼Œå› ä¸ºåˆ«äººpräº†æˆ‘çš„åº“ï¼Œæˆ‘æ¯æ¬¡éƒ½è¦å»æ‰‹åŠ¨pull =>build=>publishã€‚è¿™ä¸ªè¿‡ç¨‹çš„ç—›ç‚¹åœ¨äº

- æˆ‘çš„æœ¬åœ°éœ€è¦æœ‰ä»“åº“ä»£ç 
- npm publish ç™»å½•éªŒè¯
# how
## åŸºç¡€çŸ¥è¯†
[Microsoft](https://docs.github.com/cn/actions/quickstart)
[åŸºäº Github Action çš„ CI/CD æµç¨‹](https://zhuanlan.zhihu.com/p/250534172)
[5 åˆ†é’Ÿæ•™ä½ å¿«é€ŸæŒæ¡ GitHub Actions è‡ªåŠ¨å‘å¸ƒ Npm åŒ…å’Œç½‘ç«™](https://segmentfault.com/a/1190000041753907)
## å®æˆ˜æ“ä½œ
åœ¨** åŸºç¡€çŸ¥è¯†** ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ°äº†åŸºæœ¬github ci/cd çš„æ¦‚å¿µã€‚æˆ‘ä»¬ç°åœ¨éœ€è¦åšçš„æ˜¯é…ç½® github actionï¼Œä½¿å…¶å¯ä»¥å‘å¸ƒnpmåŒ…
### npmåŒ…æŒç»­é›†æˆ
#### ç”Ÿæˆ npm accessToken
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1447731/1652672015727-388f6db0-112e-41b1-98ef-e426bea44eea.png#clientId=uacc734b3-710d-4&from=paste&height=456&id=udc868ad4&originHeight=456&originWidth=1321&originalType=binary&ratio=1&rotation=0&showTitle=false&size=50870&status=done&style=none&taskId=u393de526-ed19-47df-896b-8b847c71a08&title=&width=1321)
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1447731/1652672097478-76b20224-2270-4c6b-9687-c75a4ec8db57.png#clientId=uacc734b3-710d-4&from=paste&height=695&id=u9d730d5d&originHeight=695&originWidth=744&originalType=binary&ratio=1&rotation=0&showTitle=false&size=79901&status=done&style=none&taskId=ub72df32b-84e7-4b1f-a32b-8a9bbf7f777&title=&width=744)
#### ç”Ÿæˆ github accessToken
[https://github.com/settings/tokens](https://github.com/settings/tokens)
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1447731/1652672260955-82587716-2641-477d-b087-49be4f63259e.png#clientId=uacc734b3-710d-4&from=paste&height=383&id=ue7e3c75c&originHeight=383&originWidth=923&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38394&status=done&style=none&taskId=uae74de4c-99ef-498a-8fb5-18bf51fb9b2&title=&width=923)
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1447731/1652672353011-f81d6b96-ea04-4f99-841b-a821d74ef5b9.png#clientId=uacc734b3-710d-4&from=paste&height=907&id=u3fa8cb04&originHeight=907&originWidth=794&originalType=binary&ratio=1&rotation=0&showTitle=false&size=86013&status=done&style=none&taskId=u74827d76-2e76-4eb6-8958-53f4397ed7f&title=&width=794)
#### åœ¨ä»“åº“ä¸­é…ç½®token
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1447731/1652672416261-1eddc752-41c3-4017-9db3-abf4a33891af.png#clientId=uacc734b3-710d-4&from=paste&height=681&id=u09c5b17c&originHeight=681&originWidth=1315&originalType=binary&ratio=1&rotation=0&showTitle=false&size=76496&status=done&style=none&taskId=u126694b5-e1e4-49cd-9d69-d61975b4234&title=&width=1315)
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1447731/1652672424196-09f6da5e-ac56-4398-8e9b-2d8217b9289e.png#clientId=uacc734b3-710d-4&from=paste&height=486&id=uc9edafff&originHeight=486&originWidth=829&originalType=binary&ratio=1&rotation=0&showTitle=false&size=14486&status=done&style=none&taskId=ue918f11a-abd1-40a6-83fe-066aeccd94a&title=&width=829)
æŠŠ npm å’Œ github çš„tokenéƒ½é…ç½®è¿›å»ï¼Œåç§°éšæ„
#### ä½¿ç”¨æ–¹å¼
| TokenName | Key | Value |
| --- | --- | --- |
| Personal Access Token | ACCESS_TOKEN | `${{ secrets.ACCESS_TOKEN }}` ï¼ˆä½ åˆšåˆšé…ç½®çš„github accessTokençš„åç§°ï¼‰ |
| Npm Access Token | NODE_AUTH_TOKEN | `${{secrets.NPM_TOKEN}}` ï¼ˆä½ åˆšåˆšé…ç½®çš„npmTokençš„åç§°ï¼‰ |

#### å†™workflow.yml
```yaml
name: "publish to npm"
on: workflow_dispatch
jobs:
    main:
        runs-on: ubuntu-latest
        steps:
            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v2
              with:
                  token: ${{ secrets.ACCESS_TOKEN }}
                  fetch-depth: 0

            - name: â” Setup node
              # sets up the .npmrc file to publish to npm
              uses: actions/setup-node@v2
              with:
                  node-version: '16.13.0'
                  registry-url: "https://registry.npmjs.org"

            - name: ğŸ“¥ Download deps
              uses: bahmutov/npm-install@v1
              with:
                  useLockFile: false

            - name: Configure git user
              run: |
                  git config --global user.email ${{ github.actor }}@users.noreply.github.com
                  git config --global user.name ${{ github.actor }}
            - name: â–¶ï¸ Run release
              run: npm run release
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```
##### å…³äºworkflowçš„å†™æ³•
githubä¸Šå¾ˆå¤šä¼˜ç§€çš„é¡¹ç›®éƒ½é…ç½®äº†workflowï¼Œå¯ä»¥å»å‚è€ƒè¿™äº›é¡¹ç›®æ€ä¹ˆå†™ã€‚æœ‰å¤šactionä¹Ÿè¢«å°è£…å¥½äº†ï¼Œå¯ä»¥åœ¨[market](https://github.com/marketplace?category=&query=&type=actions&verification=)ä¸­æœåˆ°
#### ä¸€äº›é—®é¢˜

1. npmæƒé™
```xml
npm notice 
npm ERR! code ENEEDAUTH
npm ERR! need auth This command requires you to be logged in.
npm ERR! need auth You need to authorize this machine using `npm adduser`

npm ERR! A complete log of this run can be found in:
npm ERR!     /home/runner/.npm/_logs/2022-05-16T02_33_55_906Z-debug.log
Error: Process completed with exit code 1.
```
è§£å†³æ–¹æ¡ˆï¼šé…ç½®npm 2FAï¼Œç„¶åé…ç½® è‡ªåŠ¨åŒ– npm token
