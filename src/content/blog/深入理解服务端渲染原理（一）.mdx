---
title: "æ·±å…¥ç†è§£æœåŠ¡ç«¯æ¸²æŸ“åŸç†ï¼ˆä¸€ï¼‰"
date: "2023-07-26 20:28"
draft: false
tags:
- vite
- æœåŠ¡ç«¯æ¸²æŸ“
---


# å‰è¨€
å› å†…å®¹è¾ƒå¤šï¼Œå°†åˆ†ä¸ºä¸‰æ¬¡è®²å®Œ

- æœåŠ¡ç«¯çš„åŸºæœ¬ä½¿ç”¨
- è¿›é˜¶ä½¿ç”¨
- èä¼šè´¯é€šæµè¡Œæ¡†æ¶
# ç›®æ ‡
é€šè¿‡è¿™ä¸€ç³»åˆ—çš„å­¦ä¹ ï¼Œè®©å¤§å®¶ä»æ ¹æœ¬ä¸Šç†è§£æœåŠ¡ç«¯æ¸²æŸ“åŸç†ï¼Œå¹¶è¾¾åˆ°ä¸¾ä¸€åä¸‰çš„èƒ½åŠ›ï¼Œå¯è‡ªè¡Œå¿«é€ŸæŒæ¡å„ä¸ªSSRæ¡†æ¶ï¼ˆNext.jsï¼ŒNuxtç­‰ï¼‰
# æ¸©é¦¨æç¤ºğŸ«¡
ä»¥ä¸‹å¤§éƒ¨åˆ†æ˜¯æˆ‘å®è·µâ•ä¸ªäººç†è§£æ€»ç»“å‡ºæ¥çš„ï¼Œä¸€å®šä¼šæœ‰é”™è¯¯æˆ–çº°æ¼
å¦‚æœæœ‰è®²å¾—ä¸å¯¹çš„åœ°æ–¹è¯·å½“åœºæŒ‡å‡ºï¼Œæœ‰ç–‘æƒ‘çš„åœ°æ–¹ä¹Ÿè¯·ç«‹å³æå‡ºæ¥ ğŸ™Œ

---

# å¼•è¨€
![image.png](https://cdn.nlark.com/yuque/0/2023/png/1447731/1690169754603-e6eee33d-b17e-47fa-91d7-f24f8fd16087.png#averageHue=%237a6e68&clientId=ucf0007ee-ac98-4&from=paste&height=478&id=u25e897d1&originHeight=956&originWidth=854&originalType=binary&ratio=2&rotation=0&showTitle=false&size=942309&status=done&style=none&taskId=uc7b6c311-9983-4bfa-bbea-355e4331ed3&title=&width=427)
> è‘—åå“²å­¦å®¶åº·å¾·è¯´ï¼šäººæ˜¯ç›®çš„ï¼Œè€Œä¸æ˜¯æ‰‹æ®µ
> ä¸€ä½ä¸çŸ¥åçš„å°ä¼™é˜¿æ¢¦è¯´ï¼šæŠ€æœ¯æ˜¯æ‰‹æ®µï¼Œè€Œä¸æ˜¯ç›®çš„

# å‰ç«¯æ¸²æŸ“çš„å†å²
> å°æŠ€å·§ï¼šå­¦ä¹ ä¹‹å‰å…ˆäº†è§£å‰ç«¯æ¸²æŸ“çš„å†å²èƒŒæ™¯ï¼Œæœ‰åŠ©äºæˆ‘ä»¬æ›´æ˜“ç†è§£æ¸²æŸ“æ–¹å¼

## web 1.0 æ—¶ä»£
### æ··åˆå¼€å‘ (å¦‚ SpringMVC)
> äº†è§£ä¸€ä¸‹ï¼šåˆ†å±‚çš„ç›®çš„æ˜¯ä¸ºäº†è§£è€¦ï¼Œæ˜ç¡®åˆ†å·¥ã€‚

```css
Mï¼šmodelå±‚ --- è·Ÿæ•°æ®åº“æ‰“äº¤é“
Vï¼šviewå±‚ --- è·Ÿè§†å›¾æ‰“äº¤é“
Cï¼šcontrollerå±‚ --- è·Ÿä¸šåŠ¡æ‰“äº¤é“
```

![](https://cdn.nlark.com/yuque/0/2023/jpeg/1447731/1690169733139-dbca383d-5faa-49f1-bbdb-60c450877fcd.jpeg)

> æ²¡æœ‰ä»€ä¹ˆæ˜¯åŠ ä¸€å±‚æ¶æ„æ— æ³•è§£å†³çš„ï¼Œå¦‚æœæœ‰ï¼Œå°±åŠ ä¸¤å±‚


è¿™æ˜¯ä¸€ä¸ªæ²¡æœ‰å‰ç«¯å·¥ç¨‹å¸ˆçš„å¹´ä»£ã€‚ç½‘é¡µä¹Ÿç‰¹åˆ«ç®€å•ï¼Œé¡µé¢éƒ½æ˜¯ç”±JSPã€PHPç­‰æœåŠ¡ç«¯ç”Ÿæˆåï¼Œäº¤ç»™æµè§ˆå™¨æ¸²æŸ“ã€‚åŸºæœ¬ä¸Šæ˜¯æœåŠ¡å™¨ç»™æµè§ˆå™¨ä»€ä¹ˆï¼Œæµè§ˆå™¨å°±å±•ç¤ºä»€ä¹ˆã€‚å‡ ä¹æ²¡æœ‰äº¤äº’ã€‚
è¿™ç§æ¨¡å¼åªé€‚åˆå°å‹ç®€å•çš„é¡¹ç›®ï¼Œå½“ä¸šåŠ¡å¤æ‚ä¹‹åï¼ŒJSPçš„ä»£ç ç»´æŠ¤æ€§ä¼šè¶Šæ¥è¶Šå·®ï¼Œå› ä¸ºJSPæ··åˆäº†å‰åç«¯é€»è¾‘ï¼Œæ²¡æœ‰åšåˆ†å±‚å¤„ç†

- JSPä¸­åµŒå…¥äº†JAVAä¸šåŠ¡ä»£ç 
- JSPä¹Ÿè´Ÿè´£å‰ç«¯æ¸²æŸ“
```java
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>è´­ç‰©è½¦</title>
<link href="<%=cssUrl%>bootstrap.min.css" rel="stylesheet">

<link href="<%=cssUrl%>index.css" rel="stylesheet">
<link href="<%=cssUrl%>cart.css" rel="stylesheet">
<script type="text/javascript" src="<%=jsUrl%>jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="<%=jsUrl%>bootstrap.min.js"></script>
<script type="text/javascript" src="<%=jsUrl%>cartValidate.js"></script>
<%@ include file="/commons/queryCondition.jsp" %>
</head>
<body>
<%@ include file="/commons/header.jsp"%>
<c:choose>


<c:when test="${ !empty sessionScope.ShoppingCart.computers }">
<br><br>
<div class="container">
<div class="container">
<div class="alert alert-success tip-success" id="computerNumber">æ‚¨çš„è´­ç‰©è½¦ä¸­å…±æœ‰ <b>${sessionScope.ShoppingCart.computerNumber } </b>ä»¶å•†å“</div>
<table class="table table-striped">
<tr>
<td class="col-md-6">å•†å“å</td>
<td class="col-md-2 text-center">æ•°é‡</td>
<td class="col-md-2 text-center">ä»·æ ¼</td>
<td class="col-md-2 text-center">æ“ä½œ</td>
</tr>
<c:forEach items = "${sessionScope.ShoppingCart.items }" var = "item">

<h4>User: ${user.username }</h4>
            
<tr>
<td class="col-md-6 ">
<img alt="${item.computer.id }" src="${item.computer.url }"/ style="width:180px;height:180px;">
${item.computer.brand } &nbsp; ${item.computer.model } 
</td>
<td class="col-md-2 cartItem text-center" style="height:100px;line-height: 200px;">
<input class="cartItemNum" step="${item.quantity }" type="text" size="1" name="${item.computer.id }" value="${item.quantity }" style="width:50px;height:30px;"/>
</td>
<td class="col-md-2 text-center">ï¿¥ <b>${item.computer.price }</b></td>
<td class="col-md-2 text-center">
<a class="btn btn-danger delete" href="computerServlet?method=remove&pageNo=${param.pageNo }&id=${item.computer.id }">åˆ é™¤</a>
</td>
</tr>


</c:forEach>
</table>


<div id="totalMoney" style="font-weight:bold;">æ€»é‡‘é¢ï¼šï¿¥    ${sessionScope.ShoppingCart.totalMoney }</span> 
</div>
</div>
<div class="container">
<div class="row">
<div class="col-xs-6 col-md-8"></div>
<div class="col-xs-12 col-md-4 text-right" style="padding-left:30px;">
<a href="computerServlet?method=getComputers&pageNo=${param.pageNo }" class="btn btn-default" role="button">ç»§ç»­è´­ç‰©</a>


<a href="computerServlet?method=clear" class="btn btn-danger" role="button">æ¸…ç©ºè´­ç‰©è½¦</a>

<a href="computerServlet?method=forwardPage&page=cash" class="btn btn-primary" role="button">ç»“è´¦</a>
</div>
</div>		
</div>
</div>

</c:when>
<c:otherwise>
<jsp:forward page="/WEB-INF/pages/emptycart.jsp" />
</c:otherwise>
</c:choose>
<%@ include file="/commons/footer.jsp"%>
</body>
</html>
```
![image.png](https://cdn.nlark.com/yuque/0/2023/png/1447731/1689854787786-62864d69-d7b8-4050-bffd-982abce26658.png#averageHue=%23b09263&clientId=ua0f76a4e-c149-4&from=paste&height=429&id=ud9f6211a&originHeight=858&originWidth=868&originalType=binary&ratio=2&rotation=0&showTitle=false&size=710113&status=done&style=none&taskId=ue3aa9ef3-d06c-4743-8c5f-cfc7ce42c89&title=&width=434)
### æ€»ç»“ï¼šè¿™æ˜¯ä¸€ä¸ªé‡åç«¯è½»å‰ç«¯çš„æ—¶æœŸï¼Œæ¯æ¬¡ç”¨æˆ·è¯·æ±‚èµ„æºï¼Œæ•´ä¸ªé¡µé¢éƒ½ä¼šåˆ·æ–°ï¼Œä½†è¿™ä¹Ÿæ˜¯æœåŠ¡ç«¯æ¸²æŸ“çš„é›å½¢
## web2.0 (Ajax)
Ajaxçš„å…¨ç§°æ˜¯ `Asynchronous JavaScript And XML`
> å‰ç«¯å·¥ç¨‹å¸ˆä¼´éšAjaxä¸€èµ·å‡ºç°äº†

Ajaxæ˜¯æµè§ˆå™¨å†…ç½®çš„åŠŸèƒ½ï¼Œé€šè¿‡ `xmlHttpRequest` ï¼Œå¯ä»¥å‘æœåŠ¡ç«¯å‘èµ·è¯·æ±‚ï¼Œè€Œä¸éœ€è¦åˆ·æ–°é¡µé¢ã€‚Ajaxçš„å‡ºç°æ˜¯é©å‘½æ€§çš„ï¼Œå®ƒå°±æ˜¯ä¸Šé¢å›¾ä¸­é—®é¢˜çš„ç­”æ¡ˆï¼ŒAjaxè§£è€¦äº†viewå±‚å’ŒæœåŠ¡ç«¯ï¼Œæˆä¸ºäº†ä¸­é—´æ¥å£å±‚
```javascript
function ajaxExample() {
    const xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
            document.getElementById('foo').innerHTML = this.responseText; // å“åº”
        }
    };
    xhttp.open('GET', 'https://www.bar.com/interface', true);
    xhttp.send();
}
```
é‚£ä¹ˆ... æ¥ä¸‹æ¥ï¼Œå®¢æˆ·ç«¯æ¸²æŸ“å°±å½“å½“å½“ç™»åœºäº†
### SPAï¼ˆå®¢æˆ·ç«¯æ¸²æŸ“å•é¡µåº”ç”¨ï¼‰
![](https://cdn.nlark.com/yuque/0/2023/jpeg/1447731/1690170647600-27eb9195-b082-430c-91fc-c9d7fa88c487.jpeg)

viewå±‚ä»MVCæ¡†æ¶ä¸­è„±ç¦»å‡ºæ¥ç‹¬ç«‹æˆä¸ºäº†å‰ç«¯å·¥ç¨‹å¸ˆè€•è€˜ä¹‹åœ°
éšç€ä¸šåŠ¡å¤æ‚ã€æŠ€æœ¯å‘å±•ï¼Œæ¸æ¸çš„viewå±‚åˆè¢«æ‹†åˆ†æˆäº† `MVVM` æ¶æ„ï¼ˆä¸èµ˜è¿°äº†ï¼Œè®²èµ·æ¥åˆæ˜¯ä¸€å¤§å †ï¼‰
![image.png](https://cdn.nlark.com/yuque/0/2023/png/1447731/1689863304330-89de639d-0886-406f-b560-4e838bc32600.png#averageHue=%23f3da79&clientId=uf2698d60-b797-4&from=paste&height=360&id=u3f71ab5a&originHeight=720&originWidth=1416&originalType=binary&ratio=2&rotation=0&showTitle=false&size=171710&status=done&style=none&taskId=ud8e7ac2c-0269-4ab5-8e32-cf345337abc&title=&width=708)
å‰ç«¯æ¡†æ¶ä¹Ÿæ˜¯åœ¨è¿™ä¸ªé˜¶æ®µå‡ºç°çš„ï¼š

- Angular
- React
- Vue

å®¢æˆ·ç«¯æ¸²æŸ“å¦‚ä»Šä¾ç„¶æ˜¯æœ€ä¸»æµçš„æ¸²æŸ“æ–¹å¼ï¼Œå…¶ä¼˜ç¼ºç‚¹éƒ½éå¸¸æ˜æ˜¾

ä¼˜ç‚¹
- æ— åˆ·æ–°é¡µé¢ï¼Œäº¤äº’è‰¯å¥½ï¼Œé¦–æ¬¡åŠ è½½å®Œèµ„æºåï¼Œå³å¯ç»™ç”¨æˆ·å®Œæ•´çš„ç½‘é¡µä½“éªŒ
- å‡è½»æœåŠ¡å™¨å‹åŠ›ã€‚å› ä¸ºSPAæ‰“åŒ…åéƒ½æ˜¯é™æ€èµ„æºï¼Œåªéœ€è¦ä¸€ä¸ªé™æ€èµ„æºæœåŠ¡å™¨å³å¯å®ç°é«˜æ•ˆçš„å“åº”ï¼ˆå¦‚Nginxï¼‰
- å¼€å‘æ•ˆç‡é«˜ã€ç»´æŠ¤æ€§å¼ºã€‚ç»„ä»¶åŒ–ã€æ¨¡å—åŒ–çš„å¼€å‘ï¼Œå¼€ç®±å³ç”¨çš„ç»„ä»¶æˆ–è‡ªè¡Œå°è£…ç»„ä»¶åº“ç­‰ï¼Œéƒ½å¯ä»¥å¤§å¤§æå‡å‰ç«¯å·¥ç¨‹ç»´æŠ¤æ€§å’Œå¼€å‘æ•ˆç‡ï¼›å¾—ç›Šäºæœ¬åœ°å¼€å‘æœåŠ¡ï¼ˆvite 2021å¹´ï¼‰çš„å‘å±•ï¼ŒSPAçš„çƒ­æ›´æ–°æå¿«
- **æˆ‘ä¸ªäººè§‰å¾—æœ€ä¸»è¦çš„ä¸€ç‚¹**ï¼Œå®¢æˆ·ç«¯æ¸²æŸ“ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œå¤§å¤§é™ä½äº†å‰ç«¯å¼€å‘çš„é—¨æ§›ï¼Œä¹Ÿä½¿å¾—å‰ç«¯å¼€å‘è¿‘å¹´æ¥å‘å±•è¿…çŒ›
ç¼ºç‚¹
- **æ²¡æœ‰SEO**
- **ç¬¬ä¸€æ¬¡è¿›å…¥é¡µé¢ç™½å±æ—¶é—´ä¹…**
### SSRï¼ˆæœåŠ¡ç«¯æ¸²æŸ“ AKA `Dynamic Rendering`ï¼‰
è¯¶ï¼Ÿæ€ä¹ˆåˆå›åˆ°æœåŠ¡ç«¯æ¸²æŸ“äº†ï¼Œä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡ç«¯æ¸²æŸ“ï¼Ÿ

---

æœåŠ¡ç«¯æ¸²æŸ“æœ€ä¸»è¦å°±æ˜¯ä¸ºäº†è§£å†³å®¢æˆ·ç«¯æ¸²æŸ“çš„ç¼ºç‚¹

æ­¤SSRéå½¼MVCã€‚ä»¥å‰çš„æœåŠ¡ç«¯æ¸²æŸ“æ˜¯ç”¨JAVAã€PHPè¿™äº›åç«¯è¯­è¨€æ¥åšçš„ï¼Œ
ç°å¦‚ä»Šçš„æœåŠ¡ç«¯æ¸²æŸ“æ™®éä½¿ç”¨ å‰ç«¯æ¡†æ¶ + nodejs å®ç°ï¼Œè¿˜æ˜¯è·ŸæœåŠ¡ç«¯è§£è€¦çš„

#### åŸç†
ç”¨ä¸€å¥è¯æ¦‚æ‹¬æœåŠ¡ç«¯æ¸²æŸ“åŸç†ï¼š
**ä½¿ç”¨å‰ç«¯æ¡†æ¶ï¼Œåœ¨æœåŠ¡ç«¯æŠŠé¡µé¢æ¸²æŸ“æˆæœç´¢å¼•æ“è‰¯å¥½çš„æ ¼å¼ï¼Œç„¶åè¿”å›ç»™å®¢æˆ·ç«¯æ¿€æ´»(hydration)**

ä½†æ˜¯ä¸è¦ä½ä¼°ä»»ä½•çœ‹èµ·æ¥ç®€å•çš„äº‹ï¼Œå› ä¸ºç®€å•çš„äº‹æ€»æ˜¯ä¼šå˜å¾—å¤æ‚

---

# viteä¹‹SSRæ¸²æŸ“
ç›®å‰æœ‰è®¸å¤šæµè¡Œçš„SSRæ–¹æ¡ˆï¼Œé€‰æ‹©ä¸€ä¸ªé€‚åˆé¡¹ç›®çš„å³å¯ï¼Œä¸å¿…çº ç»“ï¼ˆåšå¥½æŠ€æœ¯é€‰å‹ï¼‰
## é¥­å‰ç”œç‚¹ğŸ®
### reactç‰ˆæœ¬
#### åˆå§‹åŒ–é¡¹ç›®
```bash
pnpm create vite ssr-react-demo --template react-ts
```
#### æ–°å»ºæœåŠ¡ç«¯æ¸²æŸ“å…¥å£ï¼Œä½¿ç”¨æ¡†æ¶çš„æœåŠ¡ç«¯APIæ¸²æŸ“ç»„ä»¶
```tsx
import ReactDOMServer from 'react-dom/server'

export function render() {
  const html = ReactDOMServer.renderToString(<div id="root">Hello world</div>)
  return html
}
```
å…¥å£æ–‡ä»¶å†™å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæœåŠ¡æ¥æ‰§è¡Œè¿™ä¸ªå…¥å£
#### åˆ›å»ºæœåŠ¡
##### å®‰è£…expressï¼ˆå…¶ä»–ä»»ä½•nodeæœåŠ¡æ¡†æ¶éƒ½å¯ä»¥ï¼‰
```tsx
import express from 'express'

// åˆ›å»ºhttpæœåŠ¡
const app = express()

// ä¸ºäº†æ–¹ä¾¿å„ä½ç†è§£ï¼Œæˆ‘ä»¬æš‚æ—¶ä¸è€ƒè™‘æ­£å¼ç¯å¢ƒ

// å¼€å‘ç¯å¢ƒä¸‹æ·»åŠ viteæœåŠ¡ä¸­é—´ä»¶
const { createServer } = await import('vite')
const vite = await createServer({
	server: {
		middlewareMode: true, // ä»¥ä¸­é—´ä»¶æ¨¡å¼å¯åŠ¨viteå¼€å‘æœåŠ¡
	},
	appType: 'custom',
})
app.use(vite.middlewares)

// æ‹¦æˆªè·¯ç”±ï¼ˆ* é€šé…ç¬¦æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼‰
app.use('*', async (req, res) => {
	console.log(req);
	return res.send('Hello, world')
})


const PORT = 9527
app.listen(PORT, () => {
	console.log(`Server started at http://localhost:${PORT}`)
})
```
å…ˆå¯åŠ¨çœ‹çœ‹

okï¼ŒæŠŠviteä½œä¸ºä¸­é—´ä»¶å¯åŠ¨æœ¬åœ°æœåŠ¡æˆåŠŸäº†ï¼Œæˆ‘ä»¬ç°åœ¨è¦æŠŠReactç»„ä»¶åœ¨æœåŠ¡ç«¯æ¸²æŸ“å¥½ï¼Œç„¶åä»¥å­—ç¬¦ä¸²htmlçš„å½¢å¼è¿”å›ç»™å®¢æˆ·ç«¯
#### è¿”å›
##### åˆ›å»ºhtmlæ¨¡æ¿
```html
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + React + TS</title>
		<!-- è¿™é‡Œæ–°å¢ä¸€ä¸ªheadæ ‡ç­¾çš„å ä½ -->
		<!--app-head-->
  </head>
  <body>
		<!-- è¿™é‡Œæ–°å¢ä¸€ä¸ªæœåŠ¡ç«¯è¿”å›å†…å®¹çš„å ä½ -->
    <div id="root"><!--app-html--></div>
  </body>
</html>

```
##### ä½¿ç”¨`ssrLoadModule`è§£æå…¥å£æ–‡ä»¶
```tsx
app.use('*', async (req, res) => {
  try {
    const url = req.originalUrl
    // åœ¨è¿™é‡Œå¯ä»¥è¿”å›æœåŠ¡ç«¯æ¸²æŸ“çš„å†…å®¹ç»™å®¢æˆ·ç«¯
    let template = await fs.readFile('./index.html', 'utf-8')
    template = await vite.transformIndexHtml(url, template)
    let render = (await vite.ssrLoadModule('/src/entry-server.tsx')).render
    const rendered = await render(url)

    const html = template
      .replace(`<!--app-head-->`, rendered.head ?? '')
      .replace(`<!--app-html-->`, rendered.html ?? '')

    res.status(200).set({ 'Content-Type': 'text/html' }).end(html)
  } catch(e) {
    vite?.ssrFixStacktrace(e)
    res.status(500).end(e.stack)
  }
})
```
è¿™é‡Œæœ‰ä¸¤ä¸ªé‡ç‚¹ï¼š

- ä½¿ç”¨ `transformIndexHtml` å…ˆå¤„ç†htmlæ¨¡æ¿ï¼Œviteä¼šä¸ºæˆ‘ä»¬æ·»åŠ ä¸€äº›å®¢æˆ·ç«¯éœ€è¦çš„è„šæœ¬

![image.png](https://cdn.nlark.com/yuque/0/2023/png/1447731/1690089541139-a9685437-8964-431a-8902-313eb42266af.png#averageHue=%23393939&clientId=u6e1077e1-5797-4&from=paste&height=170&id=ud6785d96&originHeight=340&originWidth=368&originalType=binary&ratio=2&rotation=0&showTitle=false&size=22321&status=done&style=none&taskId=ub45a27c9-1c64-4438-bc2e-c100e56b959&title=&width=184)

- ä½¿ç”¨ `ssrLoadModule` è§£æssrç›¸å…³çš„æ–‡ä»¶


æˆ‘ä»¬ç°åœ¨å®ç°äº†æŠŠhtmlå­—ç¬¦ä¸²è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè¿™äº›å­—ç¬¦ä¸²æ˜¯é™æ€çš„ï¼Œä¸å…·æœ‰äº¤äº’æ€§çš„ã€‚
éœ€è¦åœ¨å®¢æˆ·ç«¯â€œæ¿€æ´»â€å­—ç¬¦ä¸²å¹¶æ·»åŠ è„šæœ¬ï¼Œä½¿å…¶å¯äº¤äº’

æˆ‘ä»¬å…ˆç›´æ¥å¯åŠ¨ï¼Œçœ‹çœ‹æœåŠ¡ç«¯è¿”å›çš„é™æ€ç½‘é¡µé•¿ä»€ä¹ˆæ ·å­

#### hydrate æ¿€æ´»
é¦–å…ˆï¼Œéœ€è¦ä¿è¯æœåŠ¡ç«¯è¿”å›çš„å†…å®¹è·Ÿå®¢æˆ·ç«¯æ¿€æ´»çš„å†…å®¹æ˜¯ä¸€è‡´çš„ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç¨å¾®æ”¹é€ ä¸€ä¸‹æœåŠ¡ç«¯å…¥å£æ–‡ä»¶
```tsx
import ReactDOMServer from 'react-dom/server'
import App from './App'

export function render() {
  // æŠŠå†…å®¹æŠ½ç¦»åˆ°Appä¸­
	const html = ReactDOMServer.renderToString(<App/>)
	return { html }
}
```
ç„¶åæ–°å»ºä¸€ä¸ªå®¢æˆ·ç«¯å…¥å£æ–‡ä»¶ï¼Œæ¸²æŸ“è·ŸæœåŠ¡ç«¯ä¸€æ ·çš„å†…å®¹ï¼ˆé‡å‘½åä¸€ä¸‹main.tsxå³å¯ï¼‰
```tsx
import './index.css'
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App'

ReactDOM.hydrateRoot(
  document.getElementById('root') as HTMLElement,
  <React.StrictMode>
    <App />
  </React.StrictMode>
)
```
æœ€åï¼ŒæŠŠå®¢æˆ·ç«¯çš„è„šæœ¬æ³¨å…¥åˆ°htmlä¸­å³å¯
```html
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + React + TS</title>
		<!-- è¿™é‡Œæ–°å¢ä¸€ä¸ªheadæ ‡ç­¾çš„å ä½ -->
		<!--app-head-->
  </head>
  <body>
		<!-- è¿™é‡Œæ–°å¢ä¸€ä¸ªæœåŠ¡ç«¯è¿”å›å†…å®¹çš„å ä½ -->
    <div id="root"><!--app-html--></div>

		<!-- æ³¨å…¥å®¢æˆ·ç«¯å…¥å£æ–‡ä»¶ï¼Œviteä¼šå»è§£æ -->
    <script type="module" src="/src/entry-client.tsx"></script>
  </body>
</html>

```

---

è¿™é‡Œæ˜¯ä¸æ˜¯å°±è·Ÿå’±ä»¬çš„SPAæ¸²æŸ“å·®ä¸å¤šï¼š
```html
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + React + TS</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
```

---

æœ€åï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å¯äº¤äº’çš„ç½‘é¡µ
![image.png](https://cdn.nlark.com/yuque/0/2023/png/1447731/1690091990082-de9a7e57-cb91-456c-bca1-25ef2d577c6b.png#averageHue=%23323232&clientId=u6e1077e1-5797-4&from=paste&height=380&id=ubf984ebe&originHeight=760&originWidth=558&originalType=binary&ratio=2&rotation=0&showTitle=false&size=78765&status=done&style=none&taskId=u4a927800-ad0a-4c5b-9add-795b2071333&title=&width=279)
è¿™äº›æ˜¯å®¢æˆ·ç«¯å…¥å£å¸¦æ¥çš„èµ„æºï¼Œè¿™äº›èµ„æºä½¿å¾—æˆ‘ä»¬çš„ç½‘é¡µæœ‰äº†äº¤äº’æ€§å’Œcssæ ·å¼
### æ³¨æ„äº‹é¡¹
æˆ‘ä»¬åœ¨æœåŠ¡ç«¯å…¥å£ã€å®¢æˆ·ç«¯å…¥å£ï¼Œéƒ½å¼•å…¥äº†ä¸€ä¸ªåä¸º `App.tsx`çš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶æˆ‘ä»¬ç§°ä¹‹ä¸ºåŒæ„æ–‡ä»¶ï¼Œ
å®ƒä¼šåœ¨å®¢æˆ·ç«¯ã€æœåŠ¡ç«¯éƒ½æ¸²æŸ“ï¼Œæˆ‘ä»¬çŸ¥é“å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ˜¯ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„ç¯å¢ƒï¼Œæœ€å…¸å‹çš„æ˜¯ï¼š
å®¢æˆ·ç«¯æ²¡æœ‰nodeï¼ŒæœåŠ¡ç«¯æ²¡æœ‰window
æ‰€ä»¥æˆ‘ä»¬åœ¨ç¼–å†™åŒæ„ä»£ç æ—¶ï¼Œéœ€è¦è€ƒè™‘ç¯å¢ƒé—®é¢˜


è‡³æ­¤ï¼Œæˆ‘ä»¬å®Œæˆäº†ä¸€ä¸ªæœ€åŸºç¡€çš„ssrï¼Œä¹Ÿæ˜¯æœ€æ ¸å¿ƒçš„åŸç†ã€‚ä¸‹æ–‡éƒ½æ˜¯åœ¨ä»¥ä¸Šæ ¸å¿ƒä¸Šåšæ‰©å±•
åœ¨ç»§ç»­è®²è§£ä¹‹å‰ï¼Œæˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨vueå®Œæˆä¸Šæ–‡ç±»ä¼¼çš„ssråŸºç¡€é¡¹ç›®ï¼Œæˆ–è®¸å¯ä»¥å¸®åŠ©å„ä½æ›´å¥½çš„ç†è§£
### vueç‰ˆæœ¬
æ€è·¯è·Ÿreactç‰ˆæœ¬å¤§åŒå°å¼‚ï¼Œæˆ‘å†å¿«é€Ÿé‡å¤ä¸€æ¬¡ï¼ŒåŠ æ·±å°è±¡
#### åˆå§‹åŒ–é¡¹ç›®
```bash
pnpm create vite ssr-vue-demo --template vue-ts
```
#### åŒæ„å…¥å£
```tsx
import { createSSRApp } from 'vue'
import App from './App.vue'


export function createApp() {
  const app = createSSRApp(App)
  return { app }
}
```
#### æœåŠ¡ç«¯æ¸²æŸ“å…¥å£
```tsx
import { renderToString } from 'vue/server-renderer'
import { createApp } from './main'

export async function render() {
  const { app } = createApp()
  const ctx = {}
  const html = await renderToString(app, ctx)

  return { html }
}
```
#### åˆ›å»ºæœåŠ¡
##### åˆ›å»ºhtmlæ¨¡æ¿
```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + Vue + TS</title>
    <!--app-head-->
  </head>
  <body>
    <div id="app"><!--app-html--></div>
  </body>
</html>

```
##### æœåŠ¡ç«¯æ¸²æŸ“
```tsx
import express from 'express'
import fs from 'fs/promises'

// åˆ›å»ºhttpæœåŠ¡
const app = express()

// ä¸ºäº†æ–¹ä¾¿å„ä½ç†è§£ï¼Œæˆ‘ä»¬æš‚æ—¶ä¸è€ƒè™‘æ­£å¼ç¯å¢ƒ

// å¼€å‘ç¯å¢ƒä¸‹æ·»åŠ viteæœåŠ¡ä¸­é—´ä»¶
const { createServer } = await import('vite')
const vite = await createServer({
	server: {
		middlewareMode: true, // ä»¥ä¸­é—´ä»¶æ¨¡å¼å¯åŠ¨viteå¼€å‘æœåŠ¡
	},
	appType: 'custom',
})
app.use(vite.middlewares)

// æ‹¦æˆªè·¯ç”±ï¼ˆ* é€šé…ç¬¦æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼‰
app.use('*', async (req, res) => {
	try {
		const url = req.originalUrl
		// åœ¨è¿™é‡Œå¯ä»¥è¿”å›æœåŠ¡ç«¯æ¸²æŸ“çš„å†…å®¹ç»™å®¢æˆ·ç«¯
		let template = await fs.readFile('./index.html', 'utf-8')
		template = await vite.transformIndexHtml(url, template)
		let render = (await vite.ssrLoadModule('/src/entry-server.ts')).render
		const rendered = await render(url)

		const html = template
		.replace(`<!--app-head-->`, rendered.head ?? '')
		.replace(`<!--app-html-->`, rendered.html ?? '')

		res.status(200).set({ 'Content-Type': 'text/html' }).end(html)
	} catch(e) {
		vite?.ssrFixStacktrace(e)
    console.log(e.stack)
    res.status(500).end(e.stack)
	}
})


const PORT = 9527
app.listen(PORT, () => {
	console.log(`Server started at http://localhost:${PORT}`)
})
```
#### å®¢æˆ·ç«¯æ¿€æ´»
```diff
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + Vue + TS</title>
    <!--app-head-->
  </head>
  <body>
    <div id="app"><!--app-html--></div>
+   <script type="module" src="/src/entry-client.ts"></script>
  </body>
</html>
```

å¯åŠ¨æœåŠ¡
![image.png](https://cdn.nlark.com/yuque/0/2023/png/1447731/1690094446171-72cf159b-42c9-41f5-940c-3e5efee10c40.png#averageHue=%23363636&clientId=u6e1077e1-5797-4&from=paste&height=364&id=uf5942cfe&originHeight=728&originWidth=494&originalType=binary&ratio=2&rotation=0&showTitle=false&size=64316&status=done&style=none&taskId=u862afda4-95ee-4cd0-aa13-11a2c944b2a&title=&width=247)

ä¹‹åéƒ½ç”¨Reactåšä¾‹å­äº†ï¼Œå› ä¸ºVueã€Reactçš„è¡¨ç°å±‚æ˜¯ç±»ä¼¼çš„ï¼Œåªæ˜¯åº•å±‚åŸç†ä¸åŒã€‚
```
å®é™…ä¸ŠVueå’ŒReactå®Œå…¨æ˜¯ä¸¤ç§è®¾è®¡ç†å¿µ
Vueæ˜¯éç»å…¸çš„MVVMæ¨¡å‹
Reactæ˜¯å‡½æ•°æ¨¡å‹
æ¡†æ¶çš„æ¨¡å‹å·®å¼‚å¾ˆå¤§ï¼Œå…¶å†…éƒ¨å®ç°å®Œå…¨ä¸åŒ
æ¯”å¦‚Vue3å‡ºäº†ç»„åˆå¼ç¼–ç¨‹ï¼Œçœ‹èµ·æ¥å¥½åƒè·ŸReactçš„hookæ¨¡å‹ä¸€æ ·ï¼Œ
ä½†å› ä¸ºä¸¤è€…æœ¬è´¨æ¨¡å‹ä¸åŒã€æ€æƒ³ä¸åŒï¼Œå°±æ³¨å®šäº†ä»–ä»¬çš„å®ç°æ–¹å¼ä¸€å®šæ˜¯ä¸ä¸€æ ·çš„
æ‰€ä»¥å°½é‡ä¸è¦æŠŠå…ˆå…¥ä¸ºä¸»çš„æ€æƒ³åŠ äºå¦ä¸€é—¨è¯­è¨€
```
### æ•´ç†ä¸€ä¸‹æ€è·¯
![](https://cdn.nlark.com/yuque/0/2023/jpeg/1447731/1690102906226-273e0779-21ba-4983-9f2c-b0a035383d4b.jpeg)

### æ¥ä¸‹æ¥è¡¥å……ä¸€ä¸‹æ­£å¼ç¯å¢ƒçš„å¤„ç†

- æ‰“åŒ…æ„å»º
- æœåŠ¡èµ„æº
- éƒ¨ç½²ä¸Šçº¿

æ—¢ç„¶æˆ‘ä»¬æå‡ºäº†â€œæ­£å¼ç¯å¢ƒâ€çš„æ¦‚å¿µï¼Œåˆ™éœ€è¦ä¸€ä¸ªå˜é‡æ¥æ§åˆ¶ç¯å¢ƒï¼Œåœ¨nodeé¡¹ç›®ä¸­ï¼Œæ™®éä½¿ç”¨`NODE_ENV`æ¥æ§åˆ¶ç¯å¢ƒ
#### æ‰“åŒ…æ„å»º
å› ä¸ºæˆ‘ä»¬æœ‰ä¸€ä¸ªæœåŠ¡ç«¯å…¥å£å‡½æ•°ã€ä¸€ä¸ªå®¢æˆ·ç«¯å…¥å£å‡½æ•°ï¼Œæ‰€ä»¥æ‰“åŒ…è‡ªç„¶ä¹Ÿéœ€è¦æ‰“ä¸¤ä¸ª
```json
"scripts": {
  "build": "npm run build:client && npm run build:server",
  "build:client": "vite build --ssrManifest --outDir dist/client",
  "build:server": "vite build --ssr src/entry-server.tsx --outDir dist/server"
},
```
æˆ‘ä»¬åˆ†æä¸‹è¿™ä¸¤ä¸ªå‘½ä»¤è¡Œ
`build:client`è®¾ç½®äº†2ä¸ªå‚æ•°ï¼š

- ssrManifestï¼šæŠŠæ‰“åŒ…åçš„èµ„æºç”Ÿæˆä¸€ä¸ªæ„å»ºæ¸…å•ï¼Œä¾›ssræ¸²æŸ“ä½¿ç”¨
- outDirï¼šæ‰“åŒ…è¾“å‡ºåˆ° dist/client ç›®å½•

`build:server`è®¾ç½®äº†2ä¸ªå‚æ•°ï¼š

- ssrï¼šè®¾ç½®è¿™æ¬¡æ‰“åŒ…æ˜¯ssræ‰“åŒ…ï¼Œæ‰“åŒ…å…¥å£æ˜¯ src/entry-server.tsx
- outDirï¼šæ‰“åŒ…è¾“å‡ºåˆ° dist/server ç›®å½•

æˆ‘ä»¬æ‰“åŒ…çœ‹çœ‹ï¼Œå¾—åˆ°çš„ç»“æœæ˜¯å¦å¦‚æˆ‘ä»¬æ‰€æ„¿
![image.png](https://cdn.nlark.com/yuque/0/2023/png/1447731/1690104257535-b20eebb4-cad6-4a37-93c5-6f747f9723e5.png#averageHue=%23232930&clientId=u6e1077e1-5797-4&from=paste&height=269&id=u339d1cc6&originHeight=538&originWidth=428&originalType=binary&ratio=2&rotation=0&showTitle=false&size=53275&status=done&style=none&taskId=ue33d63e0-aae2-4e74-83b9-99777712d2c&title=&width=214)
çœ‹èµ·æ¥æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä½¿ç”¨nodeæ¥æœåŠ¡è¿™äº›é™æ€æ–‡ä»¶
#### æœåŠ¡èµ„æº
è¯´åˆ°æœåŠ¡ï¼Œæˆ‘ä»¬å°±è¦æƒ³åˆ°æŠŠå…³æ³¨ç‚¹æ”¾åœ¨server.jsä¸Š
è¿™é‡Œç²˜ä¸€ä¸‹ä¹‹å‰çš„çº¯å¼€å‘ç¯å¢ƒçš„serverjs
```javascript
import express from 'express'
import fs from 'fs/promises'

// åˆ›å»ºhttpæœåŠ¡
const app = express()

// ä¸ºäº†æ–¹ä¾¿å„ä½ç†è§£ï¼Œæˆ‘ä»¬æš‚æ—¶ä¸è€ƒè™‘æ­£å¼ç¯å¢ƒ

// å¼€å‘ç¯å¢ƒä¸‹æ·»åŠ viteæœåŠ¡ä¸­é—´ä»¶
const { createServer } = await import('vite')
const vite = await createServer({
	server: {
		middlewareMode: true, // ä»¥ä¸­é—´ä»¶æ¨¡å¼å¯åŠ¨viteå¼€å‘æœåŠ¡
	},
	appType: 'custom',
})
app.use(vite.middlewares)

// æ‹¦æˆªè·¯ç”±ï¼ˆ* é€šé…ç¬¦æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼‰
app.use('*', async (req, res) => {
	try {
		const url = req.originalUrl
		// åœ¨è¿™é‡Œå¯ä»¥è¿”å›æœåŠ¡ç«¯æ¸²æŸ“çš„å†…å®¹ç»™å®¢æˆ·ç«¯
		let template = await fs.readFile('./index.html', 'utf-8')
		template = await vite.transformIndexHtml(url, template)
		let render = (await vite.ssrLoadModule('/src/entry-server.tsx')).render
		const rendered = await render(url)

		const html = template
		.replace(`<!--app-head-->`, rendered.head ?? '')
		.replace(`<!--app-html-->`, rendered.html ?? '')

		res.status(200).set({ 'Content-Type': 'text/html' }).end(html)
	} catch(e) {
		vite?.ssrFixStacktrace(e)
    console.log(e.stack)
    res.status(500).end(e.stack)
	}
})


const PORT = 9527
app.listen(PORT, () => {
	console.log(`Server started at http://localhost:${PORT}`)
})
```

---

ç°åœ¨æˆ‘ä»¬æ·»åŠ æ­£å¼ç¯å¢ƒç›¸å…³çš„å¤„ç†è¿›å»
```javascript
import express from 'express'
import fs from 'fs/promises'
import path from 'path'
import { fileURLToPath } from 'url'

const __dirname = path.dirname(fileURLToPath(import.meta.url))
const resolve = (p) => path.resolve(__dirname, p)

// åˆ›å»ºhttpæœåŠ¡
const app = express()

// åˆ¤æ–­ç¯å¢ƒ
const isProduction = process.env.NODE_ENV === 'production'


let vite
if(!isProduction) {
	// å¼€å‘ç¯å¢ƒä¸‹æ·»åŠ viteæœåŠ¡ä¸­é—´ä»¶
	const { createServer } = await import('vite')
	vite = await createServer({
		server: {
			middlewareMode: true, // ä»¥ä¸­é—´ä»¶æ¨¡å¼å¯åŠ¨viteå¼€å‘æœåŠ¡
		},
		appType: 'custom',
	})
	app.use(vite.middlewares)
} else {
	// æ­£å¼ç¯å¢ƒä¸‹ä¸éœ€è¦viteçš„serverä¸­é—´ä»¶äº†
	// æˆ‘ä»¬éœ€è¦è‡ªè¡Œæ“ä½œå¦‚ä½•æœåŠ¡é™æ€èµ„æº
	app.use((await import('compression')).default())
	app.use(
		(await import('serve-static')).default(resolve('dist/client'), {
			index: false,
		}),
	)
}

// htmlæ¨¡æ¿
const templateHtml = isProduction
  ? await fs.readFile(resolve('./dist/client/index.html'), 'utf-8')
  : ''

// ssræ¸²æŸ“éœ€è¦çš„é™æ€èµ„æºæ¸…å•
const ssrManifest = isProduction
  ? await fs.readFile(resolve('./dist/client/ssr-manifest.json'), 'utf-8')
  : undefined

// æ‹¦æˆªè·¯ç”±ï¼ˆ* é€šé…ç¬¦æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼‰
app.use('*', async (req, resï¼Œ next) => {
	try {
		const url = req.originalUrl
		let template
		let render
		if(!isProduction) {
			// åœ¨è¿™é‡Œå¯ä»¥è¿”å›æœåŠ¡ç«¯æ¸²æŸ“çš„å†…å®¹ç»™å®¢æˆ·ç«¯
			template = await fs.readFile('./index.html', 'utf-8')
			template = await vite.transformIndexHtml(url, template)
			render = (await vite.ssrLoadModule('/src/entry-server.tsx')).render
		} else {
			// è¯»å–clientçš„htmlæ¨¡æ¿
			template = templateHtml
      render = (await import('./dist/server/entry-server.js')).render
		}

		const rendered = await render(url, ssrManifest)

		const html = template
		.replace(`<!--app-head-->`, rendered.head ?? '')
		.replace(`<!--app-html-->`, rendered.html ?? '')

		res.status(200).set({ 'Content-Type': 'text/html' }).end(html)
	} catch(e) {
		vite?.ssrFixStacktrace(e)
    console.log(e.stack)
    res.status(500).end(e.stack)
	}
})


const PORT = 9527
app.listen(PORT, () => {
	console.log(`Server started at http://localhost:${PORT}`)
})

```
æˆ‘ä»¬å¯åŠ¨è„šæœ¬è¯•è¯•


## ä¸Šç‚¹ç¡¬èœğŸ¥˜
ä¸€ä¸ªå®Œæ•´çš„é¡¹ç›®è¿˜éœ€è¦å“ªäº›åŠŸèƒ½å‘¢ï¼Ÿ

- é¢„æ¸²æŸ“ï¼ˆSSGï¼‰
- è·¯ç”±
- çŠ¶æ€ç®¡ç†
- é™æ€èµ„æºç®¡ç†
- SEOç®¡ç†
- åˆ†æ¨¡å—æ‰“åŒ…
- æµæ¸²æŸ“
- edge runtime
- æœåŠ¡ç«¯æ¸²æŸ“ â• å®¢æˆ·ç«¯æ¸²æŸ“ï¼ˆæ··åˆæ¸²æŸ“ï¼‰
- ç»Ÿä¸€é”™è¯¯è¾¹ç•Œ
- FOUC (flash of unstyled content)
- ç¼“å­˜
- ......

æ¯ä¸ªç‚¹æ‹¿å‡ºæ¥éƒ½å¯ä»¥è¯´å¾ˆä¹…ï¼Œä½†ç¯‡å¹…æœ‰é™ä¸ºäº†ä¾¿äºå¤§å®¶ç†è§£ï¼Œæˆ‘åªä¼šè½åœ°å®ƒä»¬åç®€å•çš„å®ç°
### é¢„æ¸²æŸ“
é¢„æ¸²æŸ“ï¼Œä¹Ÿç§°ä¸ºé™æ€æ¸²æŸ“ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé¡µé¢åœ¨æ‰“åŒ…çš„æ—¶å€™è¢«æ¸²æŸ“å¥½ï¼Œä¸å¿…åœ¨å®¢æˆ·ç«¯è¯·æ±‚æ—¶å†è¢«æ¸²æŸ“ä¸€æ¬¡
é¢„æ¸²æŸ“çš„å¥½å¤„æ˜¯å¯ä»¥æå¤§ç¨‹åº¦ä¸Šå‡è½»æœåŠ¡å™¨çš„å‹åŠ›ï¼Œå¹¶ä¸”å¯ä»¥æ›´å¥½åˆ©ç”¨æœåŠ¡å™¨å’ŒCDNçš„ç¼“å­˜

è¦å®ç°é¢„æ¸²æŸ“ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦é¢„å…ˆå®šä¹‰å¥½é¡µé¢è·¯ç”±è§„åˆ™ï¼Œç„¶åæˆ‘ä»¬æ‰èƒ½æ ¹æ®è§„åˆ™ï¼ŒæŠŠç»„ä»¶é¢„å…ˆæ¸²æŸ“æˆHTML
æˆ‘ä»¬å‡è®¾`src/pages`ç›®å½•ä¸‹çš„ä¸ºé¡µé¢ç»„ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`react-router`åšå¤šé¡µé¢è·¯ç”±

å…ˆå†™å®¢æˆ·ç«¯å…¥å£æ–‡ä»¶
```tsx
import ReactDOM from 'react-dom/client'
import { BrowserRouter } from 'react-router-dom'
import { App } from './App'

ReactDOM.hydrateRoot(
  document.getElementById('app')!,
  <BrowserRouter>
    <App />
  </BrowserRouter>,
)
```

æœåŠ¡ç«¯å…¥å£æ–‡ä»¶
```tsx
import ReactDOMServer from 'react-dom/server'
import { StaticRouter } from 'react-router-dom/server'
import { App } from './App'

export function render(url: string) {
  return {
		html: ReactDOMServer.renderToString(
			<StaticRouter location={url}>
				<App />
			</StaticRouter>,
		)
	}
}
```

åŒæ„æ–‡ä»¶app.tsx
```tsx
import { Link, Route, Routes } from 'react-router-dom'

const pages = import.meta.glob('./pages/*.tsx', { eager: true }) as Record<string, any>

const routes = Object.keys(pages).map((path:string) => {
  const name = path.match(/\.\/pages\/(.*)\.tsx$/)?.[1]
  return {
    name,
    path: `/${name?.toLowerCase()}`,
    component: pages[path].default,
  }
})

export function App() {
  return (
    <>
      <nav>
        <ul>
          {routes.map(({ name, path }) => {
            return (
              <li key={path}>
                <Link to={path}>{name}</Link>
              </li>
            )
          })}
        </ul>
      </nav>
      <Routes>
        {routes.map(({ path, component: RouteComp }) => {
          return <Route key={path} path={path} element={<RouteComp />}></Route>
        })}
      </Routes>
    </>
  )
}
```
ç„¶åæˆ‘ä»¬éšä¾¿åœ¨pagesä¸­æ–°å»ºé¡µé¢ç»„ä»¶
server.jsè¿˜æ˜¯ä½¿ç”¨åŸæ¥çš„å³å¯ï¼ˆä¸€ç‚¹éƒ½ä¸éœ€è¦æ”¹ï¼‰
ç„¶åæˆ‘ä»¬å¯åŠ¨æœ¬åœ°æœåŠ¡è¯•è¯•çœ‹

---

æœ¬åœ°æœåŠ¡å…¶å®è·Ÿé¢„æ¸²æŸ“æ²¡ä»€ä¹ˆå…³ç³»ï¼Œå› ä¸ºé¢„æ¸²æŸ“æœ¬è´¨ä¸Šæ˜¯ä¸€ç§æ„å»ºå’Œæ­£å¼æœåŠ¡ä¸Šçš„ä¼˜åŒ–
æ¥ä¸‹æ¥æˆ‘ä»¬å®ç°é¢„æ¸²æŸ“
å‰æ–‡è¯´åˆ°äº†ï¼Œé¢„æ¸²æŸ“æ˜¯ æŠŠç»„ä»¶é¢„å…ˆæ¸²æŸ“æˆHTML
æ‰€ä»¥æˆ‘ä»¬éœ€è¦

1. æ ¹æ®çº¦å®šå¥½çš„è§„åˆ™ï¼Œæ‰¾åˆ°éœ€è¦é¢„æ¸²æŸ“çš„è·¯ç”±ç»„ä»¶
2. ç„¶åè°ƒç”¨å‰ç«¯æ¡†æ¶çš„æœåŠ¡ç«¯æ¸²æŸ“APIï¼ŒæŠŠç»„ä»¶æ¸²æŸ“æˆhtmlå­—ç¬¦ä¸²
3. æŠŠhtmlæ”¾åœ¨distä¸­ï¼Œæä¾›ç»™nodeèµ„æºæœåŠ¡
```javascript
import fs from 'fs'
import path from 'path'
import { fileURLToPath } from 'url'

const __dirname = path.dirname(fileURLToPath(import.meta.url))
const toAbsolute = (p) => path.resolve(__dirname, p)

// è·å–åŸºç¡€æ¨¡æ¿
const template = fs.readFileSync(toAbsolute('dist/static/index.html'), 'utf-8')
// è·å–æœåŠ¡ç«¯æ¸²æŸ“å‡½æ•°
const { render } = await import('./dist/server/entry-server.js')

// æ ¹æ®çº¦å®šå¥½çš„è§„åˆ™ï¼Œæ‰¾åˆ°éœ€è¦é¢„æ¸²æŸ“çš„è·¯ç”±
const routesToPrerender = fs
  .readdirSync(toAbsolute('src/pages'))
  .map((file) => {
    const name = file.replace(/\.tsx$/, '').toLowerCase()
    return `/${name}`
  })

// è°ƒç”¨æ¸²æŸ“å‡½æ•°ï¼ŒæŠŠç»„ä»¶æ¸²æŸ“æˆhtmlå­—ç¬¦ä¸²ï¼Œä¿å­˜åœ¨distä¸­
;(async () => {
  for (const url of routesToPrerender) {
    const context = {}
    const appHtml = await render(url, context).html

    const html = template.replace(`<!--app-html-->`, appHtml)

    const filePath = `dist/static${url === '/' ? '/index' : url}.html`
    fs.writeFileSync(toAbsolute(filePath), html)
  }
})()

```

å…ˆå¸æ”¶å¥½åŸºç¡€çŸ¥è¯†ï¼Œä¸‹æ¬¡æˆ‘ä»¬å†è®² è¿›é˜¶çš„åŸç†å’Œåº”ç”¨
### To be continued...
![image.png](https://cdn.nlark.com/yuque/0/2023/png/1447731/1690121105575-400b36f5-badb-4518-b1ef-b34fe5c0261e.png#averageHue=%23696b57&clientId=u6e1077e1-5797-4&from=paste&height=421&id=uea476541&originHeight=842&originWidth=848&originalType=binary&ratio=2&rotation=0&showTitle=false&size=761754&status=done&style=none&taskId=u779217f7-5b3c-444c-8468-7eae6447ff3&title=&width=424)




